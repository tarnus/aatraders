<?php
// 1: System Email Log
// This will allow you to view all outgoing emails generated by the game.  It will display the information about the topic, source ID, email address and if the email sent was successfull.

get_post_ifset("ip");

function user_ipwhois($ip)
{
	$ipwhois = '';

	// Check IP
	// Only supporting IPv4 at the moment...
	if (empty($ip) || !preg_match('#^(?:(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$#', $ip))
	{
		return '';
	}

	$match = array(
		'#whois\.apnic\.net#is'		=> 'whois.apnic.net',
		'#RIPE\.NET#is'				=> 'whois.ripe.net',
		'#nic\.ad\.jp#is'			=> 'whois.nic.ad.jp',
		'#whois\.registro\.br#is'	=> 'whois.registro.br'
	);

	if (($fsk = fsockopen('whois.arin.net', 43)))
	{
		fputs($fsk, "$ip\n");
		while (!feof($fsk))
		{
			$ipwhois .= fgets($fsk, 1024);
		}
		fclose($fsk);
	}

	foreach (array_keys($match) as $server)
	{
		if (preg_match($server, $ipwhois))
		{
			$ipwhois = '';
			if (($fsk = fsockopen($match[$server], 43)))
			{
				fputs($fsk, "$ip\n");
				while (!feof($fsk))
				{
					$ipwhois .= fgets($fsk, 1024);
				}
				fclose($fsk);
			}
			break;
		}
	}

	$ipwhois = htmlspecialchars($ipwhois);

	return trim(nl2br($ipwhois));
}

if ($cmd== 'whois')
{
	echo"<tr><td align=\"center\">IP Address: $ip<br><hr></font><font color=white><b>" . user_ipwhois($ip) . "</b></font><td></tr>";
	$cmd="Refresh";
}

$selfpath = basename($_SERVER['PHP_SELF']);
echo "<tr><td><form action=$selfpath method=post>";
echo "<div align=\"center\">\n";
echo "  <center>\n";
echo "  <table border=\"0\" cellpadding=\"0\" cellspacing=\"1\" width=\"100%\">\n";
echo "	<tr>\n";
echo "	  <td width=\"50%\"></td>\n";
echo "	  <td width=\"50%\" align=\"right\"><input type=\"submit\" value=\"Clear E-Logs\" name=\"cmd\"><input type=\"submit\" value=\"Refresh\" name=\"cmd\"></td>\n";
echo "  <input type=\"hidden\" name=\"game_number\" value=\"$game_number\">\n";
echo "			<input type=\"hidden\" name=\"admin_password\" value=$admin_password>\n";
echo "			<input type=\"hidden\" name=\"menu\" value=\"View_System_Email_Log\">\n";
echo "	</tr>\n";
echo "  </table>\n";
echo "  </center>\n";
echo "</div>\n";
echo "</form>\n";
if ($cmd == "Clear E-Logs")
{
	$db->Execute("DELETE FROM {$db_prefix}email_log");
	$cmd="Refresh";
}

if (empty($cmd)|| $cmd =="Refresh")
{
	$res =  $db->Execute ("SELECT * FROM {$db_prefix}email_log order by log_id DESC");
	echo "<div align=\"center\">\n";
	echo "  <center>\n";
	echo "  <table cellSpacing=\"1\" cellPadding=\"2\" width=\"100%\" bgColor=\"#e7c03d\" border=\"0\">\n";
	echo "	<tbody>\n";
	echo "	  <tr>\n";
	echo "		<td noWrap width=\"75\" bgColor=\"#800000\" align=\"center\"><font color=\"#FFFFFF\"><i><b>Source IP</b></i></font></td>\n"; 
	echo "		<td noWrap width=\"100\" bgColor=\"#800000\" align=\"center\"><font color=\"#FFFFFF\"><i><b>Destination</b></i></font></td>\n"; 
	echo "		<td noWrap bgColor=\"#800000\" align=\"center\"><font color=\"#FFFFFF\"><i><b>Log Type&nbsp;</b></i></font></td>\n"; 
	echo "		<td noWrap bgColor=\"#800000\" align=\"center\"><font color=\"#FFFFFF\"><i><b>Topic&nbsp;</b></i></font></td>\n"; 
	echo "		<td noWrap width=\"75\" bgColor=\"#800000\" align=\"center\"><font color=\"#FFFFFF\"><i><b>Delivery</b></i></font></td>\n"; 
	echo "		<td bgColor=\"#800000\" align=\"center\"><font color=\"#FFFFFF\"><i><b>Date of Log</b></i></font></td>\n"; 
	echo "	  </tr>\n"; 
	while (!$res->EOF)
	{
		$row = $res->fields;
		if ($row['e_type']==0)$LogType = "MiscEmail";
		if ($row['e_type']==1)$LogType = "Registeration";
		if ($row['e_type']==2)$LogType = "Feedback";
		if ($row['e_type']==3)$LogType = "PW Request";
		if ($row['e_type']==4)$LogType = "Failed Login";
		if ($row['e_type']==5)$LogType = "Global Email";
		if ($row['e_status']=='Y') $Delivery = "<font size=\"1\" color=\"lime\">Successful</font>";else $Delivery = "<font size=\"1\" color=\"red\">Fail</font>"; 
		echo "	  <tr>\n"; 

		echo "<td bgColor=\"#000080\" align=\"center\"><form action=admin.php method=POST>" .
			 "<INPUT TYPE=HIDDEN NAME=admin_password VALUE=$admin_password>" .
			"  <input type=\"hidden\" name=\"game_number\" value=\"$game_number\">\n" .
			 "<INPUT TYPE=HIDDEN NAME=cmd VALUE='whois'>" .
			 "<INPUT TYPE=HIDDEN NAME=menu VALUE=\"View_System_Email_Log\">" .
			 "<INPUT TYPE=HIDDEN NAME=\"ip\" VALUE=\"$row[sp_IP]\">" .
			 "<INPUT TYPE=SUBMIT VALUE=\"$row[sp_IP]\">" .
			 "</form></td>";

		echo "		<td noWrap width=\"100\" bgColor=\"#000080\" align=\"center\"><font color=\"#FFFF00\">$row[dp_name]</font></td>\n"; 
		echo "		<td bgColor=\"#000080\" align=\"center\"><font color=\"#FFFF00\">$LogType</font></td>\n"; 
		echo "		<td bgColor=\"#000080\" align=\"center\"><font color=\"#FFFF00\">$row[e_subject]</font></td>\n"; 
		echo "		<td noWrap width=\"75\" bgColor=\"#000080\" align=\"center\">$Delivery</td>\n"; 
		echo "		<td bgColor=\"#000080\" align=\"center\"><font color=\"#FFFFFF\">$row[e_stamp]</font></td>\n"; 
		echo "	  </tr>\n"; 
		$res->MoveNext(); 
	} 
	echo "</table>\n</center></div>\n"; 
	$res = ''; 
} 
?>
</td></tr>